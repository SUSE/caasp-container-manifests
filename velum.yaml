# Copyright (c) 2017 SUSE LLC. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: v1
kind: Pod
metadata:
  name: velum
  labels:
    name: velum
spec:
  hostNetwork: true
  containers:
  - name: velum-dashboard
    image: sles12/velum:0.0
    env:
    - name: RAILS_ENV
      value: production
    - name: SECRET_KEY_BASE
      value: fc0ece3811c0b1e0118dd7d619b385955e3ed146b37315d67d1c2d201c42531da398941ef27aab42493fff23afcba540390a26db51b5889e96d850a14178aabdc1926c013936a3c41abdbeb696ce440685c5d7be3a6c548434699d526a9e37657a76a43ca975b824905fd949f7e8d50aa1196a58e7e79dcfb08e2e397ee4f7b7 # FIXME: change for production (we should autogenerate this for every installation and use the autogenerated value)
    - name: VELUM_DB_HOST
      value: "127.0.0.1"
    - name: VELUM_DB_PORT
      value: "3306"
    - name: VELUM_DB_USERNAME
      value: "root" # FIXME: do not use root user
    - name: VELUM_DB_PASSWORD
      value: "salt"
    - name: VELUM_SALT_HOST
      value: "127.0.0.1"
    - name: VELUM_SALT_PORT
      value: "8000"
    - name: VELUM_SALT_USER
      value: saltapi # FIXME? -> https://github.com/openSUSE/docker-containers/blob/master/derived_images/salt/salt-master/Dockerfile#L9
    - name: VELUM_SALT_PASSWORD
      value: saltapi # FIXME? -> https://github.com/openSUSE/docker-containers/blob/master/derived_images/salt/salt-master/Dockerfile#L9
    command: ["/bin/sh","-c"]
    args: ["bundle exec rails s -b 0.0.0.0 -p 80 --pid /tmp/puma.pid Puma"]
  - name: velum-event-processor
    image: sles12/velum:0.0
    env:
    - name: WORKER_ID
      value: worker1
    - name: RAILS_ENV
      value: production
    - name: SECRET_KEY_BASE
      value: fc0ece3811c0b1e0118dd7d619b385955e3ed146b37315d67d1c2d201c42531da398941ef27aab42493fff23afcba540390a26db51b5889e96d850a14178aabdc1926c013936a3c41abdbeb696ce440685c5d7be3a6c548434699d526a9e37657a76a43ca975b824905fd949f7e8d50aa1196a58e7e79dcfb08e2e397ee4f7b7 # FIXME: change for production (we should autogenerate this for every installation and use the autogenerated value)
    - name: VELUM_DB_HOST
      value: "127.0.0.1"
    - name: VELUM_DB_PORT
      value: "3306"
    - name: VELUM_DB_USERNAME
      value: "root" # FIXME: do not use root user
    - name: VELUM_DB_PASSWORD
      value: "salt"
    - name: VELUM_SALT_HOST
      value:
    - name: VELUM_SALT_PORT
      value:
    - name: VELUM_SALT_USER
      value:
    command: ["/bin/sh","-c"]
    args: ["bundle exec bin/rake salt:process"]
  - name: velum-mariadb # FIXME: being on the same pod (with hostNetwork: true) also exposes mysql (if it listens on 0.0.0.0).
    image: sles12/mariadb:10.0
    env:
    - name: MYSQL_ROOT_PASSWORD # FIXME: do not set root password, create user/password
      value: "salt"             # FIXME
    volumeMounts:
      - mountPath: /var/lib/mysql
        name: velum-mariadb-data
  volumes:
    # Assume that database container sticks to the host that started it the very first time.
    - name: velum-mariadb-data
      hostPath:
        path: /var/lib/mysql
